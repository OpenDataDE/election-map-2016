<html>
<head>
  <meta charset=utf-8 />
  <title>Green Energy Program Grants -- An Open Data Delaware Project</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

  <!-- Load Leaflet from CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
  integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
  crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
  integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
  crossorigin=""></script>


  <!-- Load Esri Leaflet from CDN -->
  <script src="https://unpkg.com/esri-leaflet@2.1.4/dist/esri-leaflet.js"
  integrity="sha512-m+BZ3OSlzGdYLqUBZt3u6eA0sH+Txdmq7cqA1u8/B2aTXviGMMLOfrKyiIW7181jbzZAY0u+3jWoiL61iLcTKQ=="
  crossorigin=""></script>

  <script src="https://js.arcgis.com/4.7/"></script>

  <style>
    body { margin:0; padding:0; }
    #map { position: absolute; top:0; bottom:0; right:0; left:0; }
  </style>
</head>
<body>

<div id="map"></div>

<script>
  // load polygons from first layer

  let fulfilledCount = 0

  const layers = [
    {
      name: 'geothermal',
      url: 'https://firstmap.delaware.gov/arcgis/rest/services/Environmental/DE_GreenEnergyProgramGrants/MapServer/0',
      fields: {
        zip: 'ZIP5',
        totalRebate: 'SUM_TOTAL_REBATE',
        frequency: 'GEOTHERMALFREQUENCY',
        capacity: 'GEOTHERMALCAPACITYSUM'
      }
    },
    {
      name: 'pv',
      url: 'https://firstmap.delaware.gov/arcgis/rest/services/Environmental/DE_GreenEnergyProgramGrants/MapServer/1',
      fields: {
        zip: 'ZIP5',
        totalRebate: 'SUM_TOTAL_REBATE',
        frequency: 'PVFREQUENCY',
        capacity: 'PVCAPACITYSUM'
      }
    },
    {
      name: 'solarwater',
      url: 'https://firstmap.delaware.gov/arcgis/rest/services/Environmental/DE_GreenEnergyProgramGrants/MapServer/2',
      fields: {
        zip: 'ZIP5',
        totalRebate: 'SUM_TOTAL_REBATE',
        frequency: 'SOLARWATERFREQUENCY',
        capacity: 'SOLARWATERCAPACTIYSUM'
      }
    },
    {
      name: 'wind',
      url: 'https://firstmap.delaware.gov/arcgis/rest/services/Environmental/DE_GreenEnergyProgramGrants/MapServer/3',
      fields: {
        zip: 'ZIP5',
        totalRebate: 'SUM_TOTAL_REBATE',
        frequency: 'WINDFREQUENCY',
        capacity: 'WINDCAPACITYSUM'
      }
    }
  ]

  // set the map to the center of Delaware at zoom level 9
  const map = L.map("map").setView([39.144974,-75.947085], 9);

  L.esri.basemapLayer('Topographic').addTo(map);

  // data storage target object for data from layers
  const zipCodes = {}

  function formatDollars(val) {
    return parseInt(val).toLocaleString('en-US', { 
      style: 'currency', 
      currency: 'USD'
    })
  }

  layers.forEach(layer => {
    L.esri.featureLayer({
      url: layer.url
    })
    .query()
    .returnGeometry(false)
    .fields(Object.values(layer.fields))
    .limit(100)
    .run((err, featureCollection) => {
      featureCollection.features.forEach(feature => {
        if (!zipCodes[feature.properties.ZIP5]) {
          zipCodes[feature.properties.ZIP5] = {
            totalRebate: 0
          }
        }

        zipCodes[feature.properties.ZIP5][layer.name] = {
          frequency: feature.properties[layer.fields.frequency],
          totalRebate: feature.properties[layer.fields.totalRebate]
        }

        zipCodes[feature.properties.ZIP5].totalRebate += feature.properties[layer.fields.totalRebate]

      })

      if (++fulfilledCount === 4) {
        // once all zip code data has been loaded, load up the actual polygons
        const zipCodePolygons = L.esri.featureLayer({
          url: layers[0].url,
          style: { color: 'green', weight: 1 }
        }).addTo(map);

        zipCodePolygons.bindPopup(layer => {
          const properties = layer.feature.properties
          const city = properties.POSTOFFICENAME
          const zip = properties.ZIP5
          const data = zipCodes[zip]

          const lines = [
            `<b>${city}, DE ${zip}</b>`,
            `<b>Population: ${properties.POPULATION.toLocaleString('en-US')}</b>`,
            `<b>Geothermal: </b>${formatDollars(data.geothermal.totalRebate)}`,
            `<b>Photovoltaic: </b>${formatDollars(data.pv.totalRebate)}`,
            `<b>Solar Water Heating: </b>${formatDollars(data.solarwater.totalRebate)}`,
            `<b>Wind: </b>${formatDollars(data.wind.totalRebate)}`,
            `<b>Total Rebate: ${formatDollars(data.totalRebate)}</b>`,
            `<b>Per Person: ${formatDollars(data.totalRebate / properties.POPULATION)}`
          ]

          return lines.join('<BR>')

        })

      }
    })
  })



</script>

</body>
</html>
